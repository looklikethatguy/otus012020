## PAM
- Запретить всем пользователям, кроме группы admin логин в выходные (суббота и воскресенье), без учета праздников.
- *дать конкретному пользователю права работать с докером и возможность рестартить докер сервис.

### ДЗ

Создал группу admin:
- `groupadd admin`

Создал пользователей для демонстрации возможности входа:
- `useradd -p pass -s /bin/bash user1` - входит в группу admin
- `useradd -p pass -s /bin/bash user2` - не входит в группу admin

Добавил в группу admin существующих пользователей:
- `usermod -aG admin user1`

Включаем модуль `pam_time.so`. В файл `/etc/pam.d/sshd`, где нужно указать: 
- `account  required pam_time.so`

Правим `/etc/security/time.conf`, в который добавляем:
- `sshd;*;!admin;Wd`
- `login;*;!admin;Wd`

Результат записан в файле `hw_result`.

### Практика
Результат проделанных изменений находится в файле `result`, а результаты попыток входа и демонстрация возможностей пользователей в файле `login_result`.

Создал пользователей:

- ”day” - имеет удаленный доступ каждый день с 8 до 20
- “night” - с 20 до 8
- “friday” - в любое время, если сегодня пятница

Разрешил поключение по SSH с логином и паролем (в `/etc/ssh/sshd_config` изменить `PasswordAuthentication yes`).

### 1. Модуль pam_time
В файл `/etc/security/time.conf` были добавлены следующие строки:
```
*;*;day;Al0800-2000
*;*;night;!Al0800-2000
*;*;friday;Fr
```

- “*” - сервис, к которому применяется правило
- "*" - имя терминала, к которому применяется правило
- "day" - имя пользователя, для которого данное правило будет действовать
- "Al0800-200" - время, когда правило носит разрешающий характер

**NB** Учитывая, что в тестовой среде консоль была полностью русифицирована, то эффекта от добавления последней строки с указанием дня недели в формате `Fr` не последовало. В моём частном случае пришлось указывать русскоязычный аналог `Пт`. Это наглядно демонстрируется в файлах результата, когда сначала под учётной записью `friday` был выполнен успешных вход в систему, а после изменения параметров в `time.conf` войти уже было нельзя.

Для включения модуля необходимо внести изменения в файл /etc/pam.d/sshd, где нужно указать 
- `account  required pam_time.so`

### 2. Модуль pam_exec
Для этого примера используется скрипт [test_login.sh](https://gist.github.com/dmitry-lyutenko/39bf8afe5d1f6fc2d48b09c325706495).

Для использования скрипта, нужно внести изменения в файл `/etc/pam.d/sshd`:
- `account	required pam_exec.so /usr/local/bin/test_login.sh`

При запуске скрипта PAM-модулем будет передана переменная окружения `PAM_USER`, содержащая имя пользователя. Скрипт содержит простую логику: если имя пользователя `friday`, то проверям день недели, если пятница, то возвращаем 0, если нет, то 1 и завершаем скрипт.

Если же указан другой пользователь, то в строке `is_day_hours=$(($(test $hour -ge 8; echo $?)+$(test $hour -lt 20; echo $?)))` происходит проверка принадлжит ли текущее значение времени (переменная `hour`) диапазону от 8 до 20 часов. Если да, то `is_day_hours` примет значение 0, если нет 1. 

Дальше проверяем имя пользователя и соотвествие ему. Если пользователь `day` и часы "дневные", то возвращаем 0, если пользователь `night` и часы НЕ дневные, то так же возвращаем ноль. В противном случае скрипт вернет 1. Если в `PAM_USER` указано какое-то другое имя пользователя, то скрипт вернет 0.

На основании кода завершения скрипта модуль `pam_exec` принимает решение. Если вернулся 0, то все в порядке и пользователь будет авторизован, в обратном случае нет.

### 3. Модуль pam_script
Для успешной демонстрации этого способа нужно отключить SELinux (так можно делать только в тестовой среде!):
- `sudo setenforce 0`

Данный модуль не входит в базовую систему и должен быть установлен отдельно:
- `for pkg in epel-release pam_script; do yum install -y $pkg; done`

По сравнению с предыдущим примером в файле `/etc/pam.d/sshd` нужно просто переименовать `pam_exec` в `pam_script`:
- `account required pam_script.so /usr/local/bin/test_login.sh`

Для демонстрации работы модуля установим дополнительный пакет `nmap-ncat`. При выполнении команды `ncat -l -p 80` пользователем `day` мы получим ошибку, поскольку прав на прослушивание порта у него нет. Для обеспечения такой возможности, будем использовать модуль `pam_cap`, для чего в файле `/etc/pam.d/sshd` добавим:
- `auth required pam_cap.so`

и создадим файл `/etc/security/capability.conf`, содержащий строку
 -`cap_net_bind_service day`

Так же необходимо программе `/usr/bin/ncat` выдать разрешение на данное действие:
- `setcap cap_net_bind_service=ei /usr/bin/ncat`

После повторного входа в систему, пользователь `day` при вызове команды `ncat -l -p 80` больше не будет получать ошибку, а при вызове `capsh --print`, можно увидеть добавленный нами `capability`:
- `Current: = cap_net_bind_service+i`

### 4. Права администратора

Для возможности повышения прав обычным пользователем принято использовать следующие способы:
- пользователь заносится в группу `wheel`
- для него создается отдельный файл в `/etc/sudoers.d/`
- отдельная строка в `/etc/sudoers`

Поскольку сам имел отрицательный опыт редактирования файла `/etc/sudoers`, когда один случайный лишний символ ломал файл, настоятельно рекомендую сам себе использовать только первый способ и только в случае невозможности его применять, прибегать ко второму, оставив третий, самый опасный, для крайних случаев.

В первом достаточно выполнить команду:
- `usermod -G wheel day`

Во втором создать файл `/etc/sudoers.d/day` со строками:
- `day ALL=(ALL) ALL` - будет запрашивать пароль пользователя при вызове sudo
или
- `day ALL=(ALL) NOPASSWD: ALL` - не будет запрашивать пароль пользователя при вызове sudo.

**[PAM time help](http://linux-pam.org/Linux-PAM-html/sag-pam_time.html)**